# gpt_service.py

from openai import OpenAI
import os
from dotenv import load_dotenv
import logging
import json

load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
logging.basicConfig(level=logging.INFO)


def analyze_memory(text: str) -> dict:
    """GPT-4oë¥¼ ì´ìš©í•˜ì—¬ ê¸°ì–µ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ê³  JSON êµ¬ì¡°ë¡œ ë°˜í™˜"""

    # ğŸ”¹ 1. GPTì—ê²Œ system_prompt ìš”ì²­
    system_prompt = """
    ë‹¹ì‹ ì€ ì¸ê°„ì˜ ê¸°ì–µì„ ì‹œê° ì˜ˆìˆ ë¡œ ë³µì›í•˜ëŠ” 'ê°ì„± ë³µì›í˜• AI ì˜ˆìˆ  ë””ë ‰í„°'ì…ë‹ˆë‹¤.
    ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê¸°ì–µ í…ìŠ¤íŠ¸ë¥¼ ê°ì •ì Â·ì‹¬ë¦¬ì ìœ¼ë¡œ í•´ì„í•˜ê³ , 
    ê·¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í˜„ì‹¤ ì„¸ê³„ì— ì¡´ì¬í•  ë²•í•œ êµ¬ì²´ì  ì¥ë©´ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ì„¸ìš”.

    AI ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ì´ ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³ í•´ìƒë„ ì‚¬ì‹¤ì  ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë„ë¡,
    ì‹œê°ì  ë””í…Œì¼ê³¼ ê°ì •ì  ë§¥ë½ì„ ëª¨ë‘ í¬í•¨í•œ ë¶„ì„ì„ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
    (ê·¸ ì™¸ì˜ ì„¤ëª…ì´ë‚˜ ë¬¸ì¥ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.)

    ì¶œë ¥ JSON êµ¬ì¡°:
    {
      "emotion": "",          # ê¸°ì–µì˜ í•µì‹¬ ê°ì • (ì˜ˆ: ê·¸ë¦¬ì›€, ìŠ¬í””, í‰ì˜¨í•¨, ë”°ëœ»í•¨ ë“±)
      "emotion_intensity": "", # ê°ì •ì˜ ê°•ë„ (ì˜ˆ: ì•½í•¨, ì¤‘ê°„, ê°•í•¨)
      "imagery": "",           # ì‹¤ì œë¡œ ì¡´ì¬í•  ë²•í•œ ì¥ë©´ì˜ êµ¬ì²´ì  ë¬˜ì‚¬ (ì‚¬ëŒ, ì¥ì†Œ, ë°°ê²½, ë‚ ì”¨, ì¡°ëª… ë“± í˜„ì‹¤ì  ìš”ì†Œ ì¤‘ì‹¬)
      "visual_elements": "",   # ì‚¬ì§„ ì† ì£¼ìš” êµ¬ì„± ìš”ì†Œ (ì˜ˆ: ê±°ë¦¬ì˜ ê°€ë¡œë“±, ë‚¡ì€ ì±…ìƒ, íë¦° í•˜ëŠ˜ ë“±)
      "color_tone": "",        # ê°ì •ì„ ë°˜ì˜í•œ ìƒ‰ì¡°ë‚˜ ì¡°ëª… ë¶„ìœ„ê¸° (ì˜ˆ: ë”°ëœ»í•œ ì£¼í™©ë¹›, íë¦° íšŒìƒ‰ í•˜ëŠ˜ ë“±)
      "time_period": "",       # ê¸°ì–µì´ ì—°ìƒë˜ëŠ” ì‹œëŒ€ë‚˜ ì‹œê°„ëŒ€ (ì˜ˆ: 1990ë…„ëŒ€ ì„œìš¸, ê²¨ìš¸ ìƒˆë²½ ë“±)
      "location_context": "",  # ì¥ë©´ì´ ìˆì„ ë²•í•œ êµ¬ì²´ì  ì§€ì—­Â·í™˜ê²½ (ì˜ˆ: í•´ì§ˆ ë¬´ë µì˜ í•´ì•ˆê°€, ì˜¤ë˜ëœ ê³¨ëª©ê¸¸, ë‚¡ì€ ì•„íŒŒíŠ¸ ë³µë„ ë“±)
      "symbolism": "",         # ê¸°ì–µì´ ìƒì§•í•˜ëŠ” ì£¼ì œë‚˜ ë‚´ë©´ ì˜ë¯¸ (ì˜ˆ: ì‹œê°„ì˜ íë¦„, ìƒì‹¤ í›„ íšŒë³µ, ì¶”ì–µì˜ ì˜¨ê¸° ë“±)
      "visual_focus": "",      # ì´ë¯¸ì§€ì—ì„œ ê°€ì¥ ê°•ì¡°ë˜ì–´ì•¼ í•˜ëŠ” ì¤‘ì‹¬ í”¼ì‚¬ì²´ (ì˜ˆ: ì°½ê°€ì— ì•‰ì€ ì¸ë¬¼, ë¹„ì— ì –ì€ ìš°ì‚°, í…… ë¹ˆ ë†€ì´í„° ë“±)
      "camera_perspective": "" # ì¥ë©´ì„ ë³´ëŠ” ì‹œì  (ì˜ˆ: ì¸ë¬¼ì˜ ì‹œì„ ì—ì„œ, ê±°ë¦¬ í•œê°€ìš´ë°ì—ì„œ, ìœ„ì—ì„œ ë‚´ë ¤ë‹¤ë³´ëŠ” êµ¬ë„ ë“±)
    }

    ë¶„ì„ ì§€ì¹¨:
    1. ê°ì •ê³¼ ì¥ë©´ì„ **ì‹œê°ì ìœ¼ë¡œ ì—°ê²°**í•˜ì„¸ìš” â€” ê°ì •ì´ ê³µê°„, ìƒ‰, êµ¬ë„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    2. í‘œí˜„ì€ ë°˜ë“œì‹œ **í˜„ì‹¤ì **ì´ì–´ì•¼ í•˜ë©°, ì´ˆí˜„ì‹¤ì  ìš”ì†Œë‚˜ ìƒì§•ë§Œìœ¼ë¡œ êµ¬ì„±í•˜ì§€ ë§ˆì„¸ìš”.
    3. ì¥ë©´ì—ëŠ” **ì‹œê°„ì„±(time flow)**ê³¼ **ì˜¨ë„ê°(temperature)**ì´ ëŠê»´ì ¸ì•¼ í•©ë‹ˆë‹¤.
    4. ê°ì •ì  ìƒì§•(symbolism)ì€ ë°˜ë“œì‹œ **êµ¬ì²´ì  ì‚¬ë¬¼ì´ë‚˜ ê³µê°„ì  í˜•íƒœ**ë¡œ ë³€í™˜í•´ ì œì‹œí•˜ì„¸ìš”.
    5. ê²°ê³¼ëŠ” **ì‚¬ì§„ì²˜ëŸ¼ ì‚¬ì‹¤ì ì¸ ë¬˜ì‚¬**ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•´ì•¼ í•˜ë©°, í’ê²½Â·ì¸ë¬¼Â·ì¡°ëª…Â·êµ¬ë„ ì •ë³´ë¥¼ í¬í•¨í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤.
    6. ì „ì²´ JSONì€ AI ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ì´ â€˜í˜„ì‹¤ì  ì˜ˆìˆ  ì‚¬ì§„â€™ì„ ë³µì›í•  ìˆ˜ ìˆì„ ë§Œí¼ ëª…í™•í•˜ê³  ë””í…Œì¼í•´ì•¼ í•©ë‹ˆë‹¤.
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": text}
            ],
            temperature=0.7
        )
        result_text = response.choices[0].message.content

        try:
            # ğŸ”¹ 2. JSON ë¬¸ìì—´ -> íŒŒì´ì¬ ë”•ì…”ë„ˆë¦¬ (ì˜ì–´ í‚¤ + í•œê¸€ ê°’)
            result_json = json.loads(result_text)

            # ğŸ”¹ 3. index.jsë¥¼ ìœ„í•œ 'analysis' í‚¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±
            # 4ê°œì˜ í•œê¸€ ê°’ì„ í•˜ë‚˜ì˜ ìš”ì•½ ë¬¸ìì—´ë¡œ í•©ì¹©ë‹ˆë‹¤.
            analysis_summary = (
                f"ê°ì •: {result_json.get('emotion', '-')}\n"
                f"ì´ë¯¸ì§€: {result_json.get('imagery', '-')}\n"
                f"ì‹œëŒ€: {result_json.get('time_period', '-')}\n"
                f"ìƒì§•: {result_json.get('symbolism', '-')}"
            )

            # ğŸ”¹ 4. 'analysis' í‚¤ë¥¼ ë”•ì…”ë„ˆë¦¬ì— ì¶”ê°€
            result_json["analysis"] = analysis_summary

        except json.JSONDecodeError:
            # GPTê°€ JSON í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ì„ ê²½ìš°
            result_json = {"analysis": result_text, "analysis_text": result_text}

        # ğŸ”¹ 5. (ìµœì¢… ë°˜í™˜) ì˜ì–´ í‚¤ 4ê°œ + analysis í‚¤ 1ê°œê°€ í¬í•¨ëœ ë”•ì…”ë„ˆë¦¬
        return result_json

    except Exception as e:
        logging.error(f"GPT ë¶„ì„ ì‹¤íŒ¨: {e}")
        return {"analysis_error": str(e), "analysis": "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
